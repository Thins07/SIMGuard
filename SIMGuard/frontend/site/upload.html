<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMGuard | Upload Dataset</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<nav>
    <div class="nav-brand"><span>SIMGuard</span> | Upload</div>
    <ul>
        <li><a href="index.html">Introduction</a></li>
        <li><a class="active" href="upload.html">Upload</a></li>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="report.html">Report</a></li>
    </ul>
</nav>
<main class="main">
    <section class="card">
        <h1>Upload Dataset</h1>
        <p style="color:var(--muted); margin-top:6px;">Accepted formats: CSV, XLSX, XLS. Minimum columns: timestamp, user_id, sim_id, device_id, location, ip/ip_address, login_status/success.</p>

        <div class="grid two" style="margin-top:10px;">
            <div class="card" style="background:rgba(148,163,184,0.06);">
                <h3>Steps</h3>
                <ol style="margin-top:8px; padding-left:18px; color:var(--muted); line-height:1.6;">
                    <li>Select a CSV/Excel log file</li>
                    <li>System validates columns automatically</li>
                    <li>Rule-based analysis runs immediately</li>
                    <li>View results on the Dashboard</li>
                    <li>Download PDF from Report page</li>
                </ol>
            </div>
            <div class="card" style="background:rgba(34,197,94,0.06);">
                <h3>Tips for a smooth upload</h3>
                <ul style="margin-top:8px; padding-left:18px; color:var(--muted); line-height:1.6;">
                    <li>Use clear city names (e.g., "New York", "London")</li>
                    <li>Ensure timestamps are valid datetimes</li>
                    <li>login_status/success should indicate success/failed</li>
                    <li>File size limit: 16MB</li>
                </ul>
            </div>
        </div>

        <div id="uploadBox" class="upload-box" ondragover="handleDrag(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
            <p style="margin-bottom:8px;">Drag & drop file here, or</p>
            <label class="btn" for="fileInput">Choose File</label>
            <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" style="display:none" />
        </div>
        <div id="fileInfo" class="card" style="margin-top:12px; display:none;"></div>
        <div id="message" style="margin-top:12px;"></div>
        <div class="actions" style="margin-top:12px;">
            <button class="btn" onclick="startUpload()">Upload & Analyze</button>
            <a class="btn secondary" href="dashboard.html">Go to Dashboard</a>
        </div>
    </section>
</main>
<footer>SIMGuard â€¢ Rule-Based Detection</footer>

<script>
const API_BASE = 'http://localhost:5000';
let selectedFile = null;

function handleDrag(e) {
    e.preventDefault();
    document.getElementById('uploadBox').classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    document.getElementById('uploadBox').classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    document.getElementById('uploadBox').classList.remove('dragover');
    if (e.dataTransfer.files.length) {
        selectedFile = e.dataTransfer.files[0];
        showFileInfo();
    }
}

document.getElementById('fileInput').addEventListener('change', (e) => {
    if (e.target.files.length) {
        selectedFile = e.target.files[0];
        showFileInfo();
    }
});

function showFileInfo() {
    const box = document.getElementById('fileInfo');
    if (!selectedFile) return;
    box.style.display = 'block';
    box.innerHTML = `<strong>Selected:</strong> ${selectedFile.name} (${(selectedFile.size/1024).toFixed(1)} KB)`;
}

async function startUpload() {
    clearMessage();
    if (!selectedFile) {
        showMessage('Please choose a CSV or Excel file first.', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('file', selectedFile);

    try {
        showMessage('Uploading and validating file...', 'notice');
        const uploadResp = await fetch(`${API_BASE}/upload`, { method: 'POST', body: formData });
        const uploadData = await uploadResp.json();
        if (!uploadResp.ok) {
            throw new Error(uploadData.message || 'Upload failed');
        }

        showMessage('Running rule-based analysis...', 'notice');
        const analyzeResp = await fetch(`${API_BASE}/analyze`, { method: 'POST' });
        const analyzeData = await analyzeResp.json();
        if (!analyzeResp.ok) {
            throw new Error(analyzeData.message || 'Analysis failed');
        }

        sessionStorage.setItem('analysisTimestamp', analyzeData.analysis_id);
        showMessage('Analysis complete. Redirecting to dashboard...', 'success');
        setTimeout(() => window.location.href = 'dashboard.html', 800);
    } catch (err) {
        showMessage(err.message, 'error');
    }
}

function showMessage(text, variant = 'notice') {
    const el = document.getElementById('message');
    const cls = variant === 'error' ? 'error' : (variant === 'success' ? 'success' : 'notice');
    el.className = cls;
    el.textContent = text;
}

function clearMessage() {
    const el = document.getElementById('message');
    el.className = '';
    el.textContent = '';
}
</script>
</body>
</html>
